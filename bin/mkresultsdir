#!/usr/bin/env bash
# -*- bash-mode; enable-local-variables: nil -*-

# usage: mkresultsdir DESCRIPTION [SCRIPT]
# to not run an editor just use VISUAL=true mkresultsdir

set -o nounset
set -o pipefail
set -o errexit

if [ "${1:-}" == "" ]; then
    echo usage: mkresultsdir DESCRIPTION [SCRIPT]
fi

FILENAME=runall
DESCRIPTION="$1"
SCRIPT="${2:-../../src/${1}.sh}" # XXX: should modify if in year directory
YEAR="$(date +%Y)"
MONTH="$(date +%m)"
DAY="$(date +%d)"
DIRNAME="$MONTH$DAY-$DESCRIPTION"

# if the current working directory is not $YEAR, then add it
if [ "$(basename "$PWD")" != "$YEAR" ]; then
    DIRNAME="$YEAR/$DIRNAME"
fi

SHORTCUTDIRNAME="$HOME/results/$YEAR/$MONTH"

shift

mkdir -p "$DIRNAME"
cd "$DIRNAME"

if [ -e "$FILENAME" ]; then
    echo "$FILENAME already exists" >&2
else
    cat > "$FILENAME" << EOF
#!/usr/bin/env bash

command cd -P .
exec runall-wrapper "$SCRIPT" "\$@"

## Local variables:
## wrapped-script: "$SCRIPT"
## End:
EOF
fi

chmod a+rx "$FILENAME"

# create a shortcut in a central location
mkdir -p "$SHORTCUTDIRNAME"
ln -sfT "$PWD" "$SHORTCUTDIRNAME/$DAY-$DESCRIPTION"

"$VISUAL" --no-wait "$FILENAME"

# XXX: automatically creating an entry for the notebook might be helpful
