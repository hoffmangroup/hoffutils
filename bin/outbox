#!/usr/bin/env bash

## outbox: copy files to web outbox

## $Revision$
## Copyright 2010-2011 Michael M. Hoffman <mmh1@uw.edu>

set -o nounset
set -o pipefail
set -o errexit

if [ $# -lt 2 ]; then
    echo usage: "$0" DIRNAME FILE...
    exit 2
fi

YEAR="$(date +%Y)"
DIRNAME="$YEAR/outbox/$1"
shift

HTTPHOST="$(cat ~/.httphost 2> /dev/null || hostname --long)"
BASEURL="http://${HTTPHOST}/~${LOGNAME}"
BASEDIRNAME="$HOME/public_html"

for FILENAME in "$@"; do
    WHOLEDIRNAME="$(dirname "$BASEDIRNAME/$DIRNAME/$FILENAME")"

    mkdir -p "$WHOLEDIRNAME"
    cp -pr "$FILENAME" "$WHOLEDIRNAME"

    echo "$BASEURL/$DIRNAME/$FILENAME"
done

chmod a+x "$BASEDIRNAME/$DIRNAME"
chmod -R a+r "$BASEDIRNAME/$DIRNAME"
