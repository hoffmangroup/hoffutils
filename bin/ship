#!/usr/bin/env bash

## run this after release
## start in a fresh dist/$NAME-$VERSION directory

NAME="$(python setup.py --name)"
VERSION="$(python setup.py --version)"

WWWDIR="/nfs/noble/www/htdocs/proj/$NAME"
if [ ! -d "$WWWDIR" ]; then
    WWWDIR="$HOME/public_html/software/$NAME"
    mkdir -p "$WWWDIR"
fi

SRCDIR="$WWWDIR/src"
if [ ! -d "$SRCDIR" ]; then
    SRCDIR="$WWWDIR"
    mkdir -p "$SRCDIR"
fi

DOCDIR="$WWWDIR/doc/$VERSION"

# make docs
if [ -d doc ]; then
    pushd doc && (make html latex && make -C _build/latex all-pdf && evince _build/latex/*.pdf)
    popd
fi

# register and upload software
# segway is still not public
if [ "$NAME" == "segway" ]; then
    python setup.py release
else
    python setup.py release register upload
fi

### XXX: everything from here on must change for install at EBI

# copy software
cp -v "dist/$NAME-$VERSION.tar.gz" "dist/$NAME-$VERSION-py$PYTHON_VERSION"*.egg \
    "$SRCDIR"

# copy docs
if [ ! -d "$DOCDIR" ]; then
    rm -r "$DOCDIR"
fi

mkdir -p "$DOCDIR"
cp -rv doc/_build/html/* "$DOCDIR" || echo >&2 "no HTML docs"
cp -v doc/_build/latex/*.pdf "$DOCDIR" || echo >&2 "no LaTeX docs"

cp -v install.py "$WWWDIR" || echo >&2 "no install.py"

"$VISUAL" "$WWWDIR/index.html"
