#!/usr/bin/env bash

## run this after release
## start in a fresh dist/$NAME-$VERSION directory

# XXX: turn robust bash settings on

cd "${1:-.}"

NAME="$(python setup.py --name)"
VERSION="$(python setup.py --version)"

WWWDIR="/nfs/noble/www/htdocs/proj/$NAME"
if [ ! -d "$WWWDIR" ]; then
    WWWDIR="$HOME/public_html/software/$NAME"
    mkdir -p "$WWWDIR"
fi

SRCDIR="$WWWDIR/src"
if [ ! -d "$SRCDIR" ]; then
    SRCDIR="$WWWDIR"
    mkdir -p "$SRCDIR"
fi

ship-doc

# register and upload software
# segway is still not public
if [ "$NAME" == "segway" ]; then
    python setup.py release
else
    python setup.py release register upload
fi

### XXX: everything from here on must change for install at EBI

# copy software
cp -v "dist/$NAME-$VERSION.tar.gz" \
    "dist/$NAME-$VERSION-py$PYTHON_VERSION"*.egg "$SRCDIR"

cp -v install.py "$WWWDIR" || echo >&2 "no install.py"

"$VISUAL" "$WWWDIR/index.html"
